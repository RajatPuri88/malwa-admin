<script type="text/javascript">
    $(document).ready(function () {
        $('#viewTelegramMenu').addClass('current');

    });
</script>
<style>
#cover-spin {
    position:fixed;
    width:100%;
    left:0;right:0;top:0;bottom:0;
    background-color: rgba(255,255,255,0.7);
    z-index:9999;
    display:none;
}

@-webkit-keyframes spin {
	from {-webkit-transform:rotate(0deg);}
	to {-webkit-transform:rotate(360deg);}
}

@keyframes spin {
	from {transform:rotate(0deg);}
	to {transform:rotate(360deg);}
}

#cover-spin::after {
    content:'';
    display:block;
    position:absolute;
    left:48%;top:40%;
    width:40px;height:40px;
    border-style:solid;
    border-color:black;
    border-top-color:transparent;
    border-width: 4px;
    border-radius:50%;
    -webkit-animation: spin .8s linear infinite;
    animation: spin .8s linear infinite;
}



</style>


 <script src="https://js.upload.io/upload-js/v2"></script>
    <script>
      const upload = Upload({
        apiKey: "public_12a1y9LDXLoofSTGGXRgCHJHm1SC" // Your real API key.
      });

      const onFileSelected = async (event) => {
        try {
          var id=(event.target.id)
          const { fileUrl } = await upload.uploadFile(
            event.target.files[0],
            { onProgress: ({ progress }) => console.log(`${progress}% complete`) }
          );
          alert(`File uploaded!\n${fileUrl}`);
          let datatosend=JSON.stringify({'telegramLink':fileUrl})
          $.ajax({
                url: `https://api-malwa.onrender.com/api/telegram/${id}`,
                type: "PUT",
                data: datatosend,
                contentType: 'application/json; charset=utf-8',
                }).done(function (response) {
                    if(response.IsSuccess)
                    {
                        alert("file uplaoded succesfully")
                    }
            
            });
          
        } catch (e) {
          alert(`Error!\n${e.message}`);
        }
      }
    </script>
<div class="main-content">
    <div id="cover-spin"></div>

    <div class="row small-spacing">


        <div class="row small-spacing">



            <div class="box-content card white">
                <h4 class="box-title">View Telegram</h4>

                <div class="card-content">


                    <form id="viewTelegramForm">
                        <div class="col-lg-3 col-md-6 col-xs-12">

                            <div class="form-group">
                                <label for="">State</label>
                                <select class="form-control" id="stateName" name="stateName">
                                    <option value="00" selected> Select </option>
                                    <option value="Andhra Pradesh"> Andhra Pradesh </option>
                                    <option value="Arunachal Pradesh">Arunachal Pradesh </option>
                                    <option value="Assam">Assam </option>
                                    <option value="Bihar">Bihar </option>
                                    <option value="Chhattisgarh">Chhattisgarh </option>
                                    <option value="Goa">Goa </option>
                                    <option value="Gujarat">Gujarat </option>
                                    <option value="Haryana">Haryana </option>
                                    <option value="Himachal Pradesh">Himachal Pradesh </option>
                                    <option value="Jharkhand">Jharkhand </option>
                                    <option value="Karnataka">Karnataka </option>
                                    <option value="Kerala">Kerala </option>
                                    <option value="Madhya Pradesh">Madhya Pradesh </option>
                                    <option value="Maharashtra">Maharashtra </option>
                                    <option value="Manipur">Manipur </option>
                                    <option value="Meghalaya">Meghalaya </option>
                                    <option value="Mizoram">Mizoram </option>
                                    <option value="Nagaland">Nagaland </option>
                                    <option value="Odisha">Odisha </option>
                                    <option value="Punjab">Punjab </option>
                                    <option value="Rajasthan">Rajasthan </option>
                                    <option value="Sikkim">Sikkim </option>
                                    <option value="Tamil Nadu">Tamil Nadu </option>
                                    <option value="Telangana">Telangana </option>
                                    <option value="Tripura">Tripura </option>
                                    <option value="Uttar Pradesh">Uttar Pradesh </option>
                                    <option value="Uttarakhand">Uttarakhand </option>
                                    <option value="West Bengal">West Bengal</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-lg-3 col-md-6 col-xs-12">

                            <div class="form-group">
                                <label for="">Branch</label>
                                <select class="form-control" id="branchId" name="branchId"
                                    style="text-transform: capitalize">
                                    <option value="00" selected> Select</option>
                                    <option value="01"> All</option>

                                </select>
                            </div>
                        </div>

                        <div class="col-lg-3 col-md-6 col-xs-12">
                            <div class="form-group">
                                <label class="control-label">Telegram Date</label>

                                <div id="reportrange" class="pull-right form-control">
                                    <i class="fa fa-calendar"></i>
                                    <span>August 30, 2016 - September 28, 2016</span>
                                </div>

                            </div>

                        </div>


                        <div class="col-lg-12 col-md-12 col-xs-12 ">
                            <div class="form-group">
                                <button type="button" id="exporttoexcel"
                                    class="btn btn-primary btn-sm waves-effect waves-light margin-bottom-20 pull-right">Export
                                    to Excel</button>
                                <button type="button" id="viewTelegrams"
                                    class="btn btn-primary btn-sm waves-effect waves-light margin-bottom-20 margin-right-20 pull-right ">View</button>
                            </div>

                        </div>

                    </form>

                </div>
            </div>


            <div class="box-content card white">
                <h4 class="box-title">View Telegram</h4>


                <!-- /.box-title -->
                <div class="card-content">




                    <!-- /.dropdown js__dropdown -->
                    <table id="example" class="table table-striped table-bordered display" style="width:100%">
                        <thead>
                            <tr>

                                <th>Loan Code</th>
                                <th>Branch </th>
                                <th>Date of Repo</th>
                                <th>Time of Repo</th>
                                <th>Location of Repo</th>
                                <th>Nearest Police station </th>

                                <th>View Telegram</th>

                            </tr>
                        </thead>
                        <tfoot>
                            <tr>

                                <th>Loan Code</th>
                                <th>Branch </th>
                                <th>Date of Repo</th>
                                <th>Time of Repo</th>
                                <th>Location of Repo</th>
                                <th>Nearest Police station </th>

                                <th>View Telegram</th>

                            </tr>
                        </tfoot>
                        <tbody>
                            {{#each messagesData}}

                            <tr>
                                <td>{{loanNo}}</td>
                                <td style="text-transform: capitalize">{{branch_id.name}}</td>
                                <td> {{punch_date_string}} </td>
                                <td> {{punch_time_string}} </td>
                                <td style="text-transform: capitalize"> {{locationAddress}}</td>
                                <td style="text-transform: capitalize"> {{nearestPoliceStation}}</td>
                                {{#if telegramLink}}
                                <td><a href="{{telegramLink}}" target="_blank">View File</a></td>
                                {{else}}
                                <td><input type="file" id="{{_id}}" onchange="onFileSelected(event)"/></td>
                                {{/if}}
                            </tr>

                            {{/each}}




                        </tbody>
                    </table>
                </div>
            </div>

        </div>





    </div>

</div>






<script type="text/javascript">


    function viewRepo(repoLink) {
        Swal.fire({

            imageUrl: repoLink,
            imageWidth: 400,
            imageHeight: 200,
        })

    }


    $('#stateName').on('change', function () {

        if (this.value != '00') {
            // reading branches for this state
            $.ajax({
                method: "GET",
                url: "/branch/" + this.value,

                headers: {
                    'Content-Type': 'application/json'
                }
            })
                .done(function (msg) {
                    if (msg.IsSuccess == true) {


                        $("#branchId").find('option').not(':first').remove();
                        $('#branchId').append($('<option>', {
                            value: '01',
                            text: 'All'
                        }));
                        $("#userType").find('option').not(':first').remove();
                        msg.Branches.map((it) => {
                            $('#branchId').append($('<option>', {
                                value: it._id,
                                text: it.name
                            }));
                        })


                    }
                    else {
                        swal({
                            title: "Oh no!",
                            text: msg.Message,
                            icon: "error",
                            button: "Ok!",
                        });
                    }
                });

        }
    });



    $('#viewTelegrams').on('click', function () {

        // if state is selected then ask for branch

        let fromDateString = moment($('#reportrange span').html().split('-')[0].trim(), 'MMMM D, YYYY').format('DD-MM-YYYY')
        let toDateString = moment($('#reportrange span').html().split('-')[1].trim(), 'MMMM D, YYYY').format('DD-MM-YYYY')

        if ($('#stateName').val() == '00') {

            Swal.fire({
                icon: 'error',
                title: 'Oops...',
                text: 'You must select users branch state!'
            })

            return;
        }


        if ($('#stateName').val() != '00' && $('#branchId').val() == '00') {

            Swal.fire({
                icon: 'error',
                title: 'Oops...',
                text: 'You must select users branch state!'
            })

            return;
        }


        

        var dataTosend = {
            branch_id: $('#branchId').val(),
            state_id: $('#stateName').val().toLowerCase(),
            fromDateString: fromDateString,
            toDateString: toDateString
        }


        $.ajax({
            method: "POST",
            url: "/view-telegram",
            data: JSON.stringify(dataTosend),
            headers: {
                'Content-Type': 'application/json'
            }
        })
            .done(function (msg) {
                if (msg.IsSuccess == true) {

                    // clear existing table and add new data
                    $("#example").empty();
                    if ($.fn.DataTable.isDataTable("#example")) {
                        $('#example').DataTable().clear().destroy();
                    }
                    let tRows = '';
                    msg.telegrams.map((r) => {
                        tRows = tRows + `<tr>
                            <td style="text-transform: capitalize"> ${r.loanNo} </td>
                            
                            <td style="text-transform: capitalize"> ${r.branch_id.name} </td>
                            
                            <td style="text-transform: capitalize"> ${r.punch_date_string} </td>
                            <td style="text-transform: capitalize"> ${r.punch_time_string} </td>
                            <td style="text-transform: capitalize"> ${r.locationAddress} </td>
                            <td style="text-transform: capitalize"> ${r.nearestPoliceStation} </td>
                            <td> <a href="#" onclick="return viewRepo('${r.telegramLink}');">View file</a> </td>
                            
                             </tr>
                            `;
                    })
                    $("#example").append(`
                                
                                <tbody>
                                    ${tRows}
                                </tbody>
                                `);

                    $("#example").dataTable();



                }
                else {
                    swal({
                        title: "Oh no!",
                        text: msg.Message,
                        icon: "error",
                        button: "Ok!",
                    });
                }
            });




    })

</script>